<!-- /* Load the library */ -->
<script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<!-- /* Basic and simple one */ -->
<div id="qrcode"></div>

<!-- /*With some options*/ -->
<title>Amazing qr code generator</title>
<div id="qrcode-2"></div>
<div class="top-page">
  <div class="form">
    <div class="label-input">
      <label for="site-title">Title</label>
      <input id="site-title" type="text" />
    </div>
    <div class="label-input">
      <label for="site-url">Url</label>
      <input id="site-url" type="text" aria-label="site name" />
    </div>
    <div class="label-input">
      <label for="qr-color">Color</label>
      <input id="qr-color" type="color" />
    </div>
    <button id="submit-button">submit</button>
  </div>
  <div class="form">
    <p>Batch upload</p>
    <p>Example csv: <a href="./example.csv" download>example.csv</a></p>
    <div class="label-input">
      <label for="batch-upload">Csv file</label>
      <input type="file" id="batch-upload" />
    </div>
    <button id="submit-batch-button">submit</button>
  </div>
</div>
<div id="download-all-container" class="download-all-container"></div>
<div id="qr-list" class="qr-list"></div>
<script type="text/javascript">
  document.getElementById("submit-button").addEventListener("click", addNewQr);
  document
    .getElementById("submit-batch-button")
    .addEventListener("click", batchUpload);
  var qrLocation = 1;
  var allSources = [];

  function batchUpload(e) {
    var file = document.getElementById("batch-upload");
    var input = file.files[0];
    const reader = new FileReader();
    reader.onload = function (e) {
      const lines = e.target.result.split("\n");
      lines.forEach((line) => {
        const rows = line.split(",");
        if (rows[0] !== "title") {
          const title = rows[0];
          const url = rows[1];
          const color = rows[2].replace("\r", "");

          makeQrCode(url, title, color);
        }
      });
    };
    reader.readAsText(input);
  }

  function addNewQr(e) {
    var color = document.getElementById("qr-color").value;
    var url = document.getElementById("site-url").value;
    var title = document.getElementById("site-title").value;

    makeQrCode(url, title, color);
  }
  function makeDownloadAllButton() {
    var downloadAllButton = document.createElement("button");
    downloadAllButton.setAttribute("id", "download-all");
    var downloadAllText = document.createTextNode("Download all");
    downloadAllButton.appendChild(downloadAllText);
    document
      .getElementById("download-all-container")
      .appendChild(downloadAllButton);

    downloadAllButton.addEventListener("click", function () {
      for (let i = 1; i < qrLocation; i++) {
        const button = document.getElementById(`qr-button-${i}`);
        button.click();
      }
    });
  }
  function makeQrCode(url, title, color) {
    var downloadAll = document.getElementById("download-all");
    if (downloadAll === null) {
      makeDownloadAllButton();
    }

    var titleElement = document.createTextNode(title);

    var qrElement = document.createElement("div");
    qrElement.setAttribute("id", `qrcode-${qrLocation}`);
    qrElement.setAttribute("class", "qr-value");
    document.getElementById("qr-list").appendChild(qrElement);

    qrElement.appendChild(titleElement);
    var qrcode = new QRCode(qrElement, {
      text: url,
      width: 128,
      width: 128,
      height: 128,
      colorDark: color,
      colorLight: "#ffffff",
      correctLevel: QRCode.CorrectLevel.H,
    });

    var button = document.createElement("button");
    const currentQrLocation = qrLocation;
    button.setAttribute("id", `qr-button-${qrLocation}`);
    button.addEventListener("click", function () {
      var src = qrElement.children[1].getAttribute("src");
      var link = document.createElement("a");
      link.href = src;
      link.download = `${title}.jpg`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    });
    var text = document.createTextNode("Download");
    button.appendChild(text);
    qrElement.appendChild(button);

    const source = qrElement.children[1].getAttribute("src");
    allSources.push({ source, title });
    qrLocation++;
  }
</script>

<style>
  .qr-list {
    width: 100%;
    display: flex;
    flex-wrap: wrap;
    justify-content: space-around;
  }
  .qr-value {
    display: flex;
    flex-direction: column;
    padding: 1rem;
  }
  .form {
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    width: 45%;
    min-width: 5.625rem;
    min-height: 10rem;
    height: 20vh;
  }
  .label-input {
    display: flex;
    flex-direction: column;
  }

  .download-all-container {
    width: 100%;
    display: flex;
    justify-content: center;
    margin-top: 2rem;
  }

  @media screen and (min-width: 400px) {
    .top-page {
      display: flex;
      justify-content: space-around;
    }
  }

  @media screen and (max-width: 400px) {
    .top-page {
      display: flex;
      justify-content: space-between;
    }
  }
</style>
